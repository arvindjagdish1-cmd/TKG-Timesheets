{% extends "base.html" %}
{% load static socialaccount %}

{% block title %}Welcome - Keystone Timesheet Portal{% endblock %}

{% block content %}
<div class="keystone-login-page" id="loginPage">
    <canvas id="temporalCanvas"></canvas>

    <div class="login-container">
        <div class="logo-container">
            <img src="{% static 'images/keystone-logo.png' %}" alt="Keystone" class="keystone-logo" onerror="this.style.display='none';">
        </div>

        <div class="welcome-text">
            <h1>Keystone Timesheet Portal</h1>
        </div>

        <div class="login-options">
            {% if messages %}
            {% for message in messages %}
            <div class="alert-message {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
            {% endif %}

            <a href="{% provider_login_url 'microsoft' %}" class="btn-login btn-signin">
                <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 21 21">
                    <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
                    <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
                    <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
                    <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
                </svg>
                <span>Sign in with Microsoft</span>
            </a>

            <p class="help-text">
                Access is limited to approved @thekeystonegroup.com accounts.
            </p>
        </div>

        <div class="login-footer">
            <p>&copy; {% now "Y" %} The Keystone Group. All rights reserved.</p>
        </div>
    </div>
</div>

<style>
    .keystone-login-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        overflow: hidden;
        position: relative;
        background: #07080a;
    }

    #temporalCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
    }

    .login-container {
        max-width: 440px;
        width: 100%;
        text-align: center;
        position: relative;
        z-index: 1;
        background: rgba(15, 17, 22, 0.65);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 1.25rem;
        padding: 3rem 2.5rem;
        backdrop-filter: blur(40px) saturate(1.4);
        -webkit-backdrop-filter: blur(40px) saturate(1.4);
        box-shadow:
            0 0 0 1px rgba(255, 255, 255, 0.04),
            0 20px 60px rgba(0, 0, 0, 0.5),
            0 0 120px rgba(74, 144, 217, 0.06);
    }

    .logo-container {
        margin-bottom: 2rem;
        animation: logoReveal 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        opacity: 0;
    }

    .keystone-logo {
        width: 120px;
        height: auto;
        filter: drop-shadow(0 0 24px rgba(100, 149, 237, 0.3));
        transition: filter 0.4s ease, transform 0.4s ease;
    }

    .logo-container:hover .keystone-logo {
        filter: drop-shadow(0 0 36px rgba(100, 149, 237, 0.5));
        transform: scale(1.05);
    }

    @keyframes logoReveal {
        0% { opacity: 0; transform: translateY(-30px) scale(0.9); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .welcome-text {
        margin-bottom: 2.5rem;
        animation: contentFade 0.8s ease-out 0.3s forwards;
        opacity: 0;
    }

    .welcome-text h1 {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 1.5rem;
        font-weight: 600;
        color: #f0f2f5;
        margin: 0;
        letter-spacing: -0.02em;
    }

    @keyframes contentFade {
        0% { opacity: 0; transform: translateY(12px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    .login-options {
        animation: contentFade 0.8s ease-out 0.55s forwards;
        opacity: 0;
    }

    .alert-message {
        background: rgba(239, 68, 68, 0.08);
        border: 1px solid rgba(239, 68, 68, 0.2);
        color: #f87171;
        padding: 0.75rem 1rem;
        border-radius: 0.625rem;
        margin-bottom: 1.25rem;
        font-size: 0.875rem;
    }

    .alert-message.alert-success {
        background: rgba(34, 197, 94, 0.08);
        border-color: rgba(34, 197, 94, 0.2);
        color: #4ade80;
    }

    .btn-login {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.875rem 1.5rem;
        border-radius: 0.625rem;
        font-size: 0.9375rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        border: none;
    }

    .btn-signin {
        background: #ffffff;
        color: #111;
        box-shadow: 0 2px 10px rgba(255, 255, 255, 0.08);
    }

    .btn-signin:hover {
        background: #f5f5f5;
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(255, 255, 255, 0.12);
        color: #111;
        text-decoration: none;
    }

    .btn-signin:active {
        transform: translateY(0);
    }

    .help-text {
        margin-top: 1.5rem;
        font-size: 0.8125rem;
        color: rgba(255, 255, 255, 0.35);
        line-height: 1.5;
    }

    .login-footer {
        margin-top: 2.5rem;
        animation: contentFade 0.8s ease-out 0.8s forwards;
        opacity: 0;
    }

    .login-footer p {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.2);
        margin: 0;
        letter-spacing: 0.02em;
    }

    @media (max-width: 480px) {
        .keystone-login-page { padding: 1.25rem; }
        .login-container { padding: 2rem 1.5rem; }
        .welcome-text h1 { font-size: 1.25rem; }
        .keystone-logo { width: 90px; }
    }
</style>

<script>
(function () {
    const canvas = document.getElementById('temporalCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let w, h, particles, arcs, mouse;

    function getTimeColors() {
        const hour = new Date().getHours();
        if (hour >= 6 && hour < 12) {
            return { bg: [7, 8, 14], accent: [74, 144, 217], glow: [100, 170, 240] };
        } else if (hour >= 12 && hour < 17) {
            return { bg: [10, 10, 16], accent: [60, 130, 200], glow: [80, 160, 230] };
        } else if (hour >= 17 && hour < 21) {
            return { bg: [8, 6, 14], accent: [120, 80, 180], glow: [160, 100, 220] };
        } else {
            return { bg: [5, 5, 12], accent: [40, 80, 160], glow: [60, 100, 180] };
        }
    }

    const colors = getTimeColors();
    mouse = { x: -1000, y: -1000 };

    function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
    }

    function initParticles() {
        particles = [];
        const count = Math.floor((w * h) / 18000);
        for (let i = 0; i < count; i++) {
            particles.push({
                x: Math.random() * w,
                y: Math.random() * h,
                vx: (Math.random() - 0.5) * 0.3,
                vy: (Math.random() - 0.5) * 0.3,
                r: Math.random() * 1.5 + 0.5,
                a: Math.random() * 0.4 + 0.1,
            });
        }
    }

    function initArcs() {
        arcs = [];
        for (let i = 0; i < 3; i++) {
            arcs.push({
                cx: w * (0.25 + Math.random() * 0.5),
                cy: h * (0.25 + Math.random() * 0.5),
                radius: 80 + Math.random() * 160,
                startAngle: Math.random() * Math.PI * 2,
                speed: (Math.random() - 0.5) * 0.004,
                length: Math.PI * (0.3 + Math.random() * 0.5),
                alpha: 0.04 + Math.random() * 0.06,
            });
        }
    }

    function draw(t) {
        ctx.fillStyle = `rgb(${colors.bg[0]}, ${colors.bg[1]}, ${colors.bg[2]})`;
        ctx.fillRect(0, 0, w, h);

        const grad = ctx.createRadialGradient(w * 0.5, h * 0.4, 0, w * 0.5, h * 0.4, Math.max(w, h) * 0.7);
        grad.addColorStop(0, `rgba(${colors.accent[0]}, ${colors.accent[1]}, ${colors.accent[2]}, 0.06)`);
        grad.addColorStop(0.5, `rgba(${colors.accent[0]}, ${colors.accent[1]}, ${colors.accent[2]}, 0.02)`);
        grad.addColorStop(1, 'transparent');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, w, h);

        for (const arc of arcs) {
            arc.startAngle += arc.speed;
            ctx.beginPath();
            ctx.arc(arc.cx, arc.cy, arc.radius, arc.startAngle, arc.startAngle + arc.length);
            ctx.strokeStyle = `rgba(${colors.glow[0]}, ${colors.glow[1]}, ${colors.glow[2]}, ${arc.alpha})`;
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        const connectionDist = 120;
        for (let i = 0; i < particles.length; i++) {
            const p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            if (p.x < 0) p.x = w;
            if (p.x > w) p.x = 0;
            if (p.y < 0) p.y = h;
            if (p.y > h) p.y = 0;

            const dx = mouse.x - p.x;
            const dy = mouse.y - p.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            let alpha = p.a;
            if (dist < 200) {
                alpha = p.a + (1 - p.a) * (1 - dist / 200) * 0.5;
            }

            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(${colors.glow[0]}, ${colors.glow[1]}, ${colors.glow[2]}, ${alpha})`;
            ctx.fill();

            for (let j = i + 1; j < particles.length; j++) {
                const q = particles[j];
                const ddx = p.x - q.x;
                const ddy = p.y - q.y;
                const d = Math.sqrt(ddx * ddx + ddy * ddy);
                if (d < connectionDist) {
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(q.x, q.y);
                    ctx.strokeStyle = `rgba(${colors.glow[0]}, ${colors.glow[1]}, ${colors.glow[2]}, ${0.06 * (1 - d / connectionDist)})`;
                    ctx.lineWidth = 0.5;
                    ctx.stroke();
                }
            }
        }

        requestAnimationFrame(draw);
    }

    window.addEventListener('resize', function () { resize(); initParticles(); initArcs(); });
    document.addEventListener('mousemove', function (e) { mouse.x = e.clientX; mouse.y = e.clientY; });
    document.addEventListener('mouseleave', function () { mouse.x = -1000; mouse.y = -1000; });

    resize();
    initParticles();
    initArcs();
    requestAnimationFrame(draw);
})();
</script>
{% endblock %}
