{% extends "base.html" %}

{% block title %}Expense Report - {{ report.month.display_name }} - TKG T&E{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-start">
    <div>
        <h1>Expense Report</h1>
        <p class="text-muted mb-0">{{ report.month.display_name }} Â· {{ report.employee.get_full_name }}</p>
    </div>
    <div class="text-end">
        <span class="badge-status badge-{{ report.status|lower }}" style="font-size: 0.9rem;">{{ report.get_status_display }}</span>
        <div class="h4 mb-0 mt-2" style="font-family: var(--font-mono);">${{ report.grand_total|floatformat:2 }}</div>
    </div>
</div>

<!-- Summary -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="text-muted small">Expenses</div>
                <div class="h3 mb-0" style="font-family: var(--font-mono);">${{ report.total_expenses|floatformat:2 }}</div>
                <small class="text-muted">{{ items|length }} items</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="text-muted small">Mileage</div>
                <div class="h3 mb-0" style="font-family: var(--font-mono);">${{ report.total_mileage_amount|floatformat:2 }}</div>
                <small class="text-muted">{{ mileage_entries|length }} entries</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100 bg-primary text-white">
            <div class="card-body text-center">
                <div class="small opacity-75">Grand Total</div>
                <div class="h3 mb-0" style="font-family: var(--font-mono);">${{ report.grand_total|floatformat:2 }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Expense Items -->
{% if items %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-receipt me-2"></i>Expense Items
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Client</th>
                        <th class="text-center">Receipt</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ item.date|date:"M j" }}</td>
                        <td>{{ item.category.name }}</td>
                        <td>{{ item.description }}</td>
                        <td>{{ item.client|default:"-" }}</td>
                        <td class="text-center">
                            {% if item.receipts.exists %}
                            <span class="text-success"><i class="bi bi-check-circle"></i></span>
                            {% elif item.paper_receipt_delivered %}
                            <span class="text-info"><i class="bi bi-file-text" title="Paper receipt"></i></span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end" style="font-family: var(--font-mono);">${{ item.amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th colspan="5">Total Expenses</th>
                        <th class="text-end" style="font-family: var(--font-mono);">${{ report.total_expenses|floatformat:2 }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Mileage -->
{% if mileage_entries %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-car-front me-2"></i>Mileage
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th class="text-end">Miles</th>
                        <th class="text-end">Rate</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in mileage_entries %}
                    <tr>
                        <td>{{ entry.date|date:"M j" }}</td>
                        <td>{{ entry.description }}</td>
                        <td class="text-end" style="font-family: var(--font-mono);">{{ entry.miles }}</td>
                        <td class="text-end" style="font-family: var(--font-mono);">${{ entry.rate|floatformat:3 }}</td>
                        <td class="text-end" style="font-family: var(--font-mono);">${{ entry.total_amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th colspan="4">Total Mileage</th>
                        <th class="text-end" style="font-family: var(--font-mono);">${{ report.total_mileage_amount|floatformat:2 }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Notes -->
{% if report.employee_notes %}
<div class="card mb-4">
    <div class="card-header"><i class="bi bi-chat-left-text me-2"></i>Employee Notes</div>
    <div class="card-body">{{ report.employee_notes|linebreaks }}</div>
</div>
{% endif %}

{% if report.reviewer_notes %}
<div class="card mb-4 border-warning">
    <div class="card-header bg-warning-subtle"><i class="bi bi-chat-right-text me-2"></i>Reviewer Notes</div>
    <div class="card-body">{{ report.reviewer_notes|linebreaks }}</div>
</div>
{% endif %}

<!-- Actions -->
<div class="d-flex gap-2 flex-wrap">
    <a href="{% url 'timesheets:dashboard' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Dashboard
    </a>
    <a href="{% url 'expenses:expense_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-list me-2"></i>All Reports
    </a>
    {% if report.is_editable and report.employee == request.user %}
    <div class="flex-grow-1"></div>
    <a href="{% url 'expenses:expense_edit' report.pk %}" class="btn btn-primary">
        <i class="bi bi-pencil me-2"></i>Edit
    </a>
    {% endif %}
</div>
{% endblock %}
