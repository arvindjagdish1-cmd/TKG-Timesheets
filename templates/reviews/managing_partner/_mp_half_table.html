{% load timesheet_tags %}

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>{{ half_label }}</span>
        <small class="text-muted">Drag project rows to reorder</small>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table mp-table mb-0" id="table-{{ table_id }}">
                <thead>
                    <tr>
                        <th class="project-header" style="min-width: 240px;">Project</th>
                        <th class="status-header" style="min-width: 80px;">Status</th>
                        {% for emp in employees %}
                        <th class="emp-header" title="{{ emp.get_full_name|default:emp.email }}">
                            {% if emp.profile_or_none %}
                                {{ emp.profile_or_none.initials|default:emp.first_name|truncatechars:3 }}
                            {% else %}
                                {{ emp.first_name|truncatechars:3 }}
                            {% endif %}
                        </th>
                        {% endfor %}
                        <th class="total-col">Total</th>
                    </tr>
                </thead>

                <!-- Client Work Section -->
                <tbody>
                    <tr class="section-header-row">
                        <td colspan="{{ employees|length|add:3 }}">Client Work</td>
                    </tr>
                </tbody>
                <tbody class="client-sortable" id="clients-{{ table_id }}">
                    {% for row in matrix %}
                    {% if row.group == "client" %}
                    <tr data-project="{{ row.label }}" {% if row.active == "Inactive" %}class="inactive-project"{% endif %}>
                        <td class="project-cell" title="{{ row.label }}">
                            <i class="bi bi-grip-vertical text-muted me-1" style="font-size:0.6rem;"></i>{{ row.label }}
                        </td>
                        <td class="status-cell {% if row.active == 'Inactive' %}text-danger{% endif %}">{{ row.active|default:"Active" }}</td>
                        {% for emp in employees %}
                        <td>{{ row.values|get_item:emp.id|zero_dash }}</td>
                        {% endfor %}
                        <td class="total-col">{{ row.total|zero_dash }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>

                <!-- Total Chargeable -->
                <tbody>
                    {% for row in matrix %}
                    {% if row.group == "total_chargeable" %}
                    <tr class="total-row">
                        <td class="project-cell" style="cursor:default;">{{ row.label }}</td>
                        <td class="status-cell"></td>
                        {% for emp in employees %}
                        <td>{{ row.values|get_item:emp.id|zero_dash }}</td>
                        {% endfor %}
                        <td class="total-col">{{ row.total|zero_dash }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>

                <!-- Marketing Section -->
                <tbody>
                    <tr class="section-header-row">
                        <td colspan="{{ employees|length|add:3 }}">Marketing</td>
                    </tr>
                    {% for row in matrix %}
                    {% if row.group == "marketing" %}
                    <tr class="non-draggable">
                        <td class="project-cell" style="cursor:default;">{{ row.label }}</td>
                        <td class="status-cell"></td>
                        {% for emp in employees %}
                        <td>{{ row.values|get_item:emp.id|zero_dash }}</td>
                        {% endfor %}
                        <td class="total-col">{{ row.total|zero_dash }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>

                <!-- Total Marketing -->
                <tbody>
                    {% for row in matrix %}
                    {% if row.group == "total_marketing" %}
                    <tr class="total-row">
                        <td class="project-cell" style="cursor:default;">{{ row.label }}</td>
                        <td class="status-cell"></td>
                        {% for emp in employees %}
                        <td>{{ row.values|get_item:emp.id|zero_dash }}</td>
                        {% endfor %}
                        <td class="total-col">{{ row.total|zero_dash }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>

                <!-- Other Hours Section -->
                <tbody>
                    <tr class="section-header-row">
                        <td colspan="{{ employees|length|add:3 }}">Other Hours</td>
                    </tr>
                    {% for row in matrix %}
                    {% if row.group == "other" %}
                    <tr class="non-draggable">
                        <td class="project-cell" style="cursor:default;">{{ row.label }}</td>
                        <td class="status-cell"></td>
                        {% for emp in employees %}
                        <td>{{ row.values|get_item:emp.id|zero_dash }}</td>
                        {% endfor %}
                        <td class="total-col">{{ row.total|zero_dash }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>

                <!-- Total Other Hours -->
                <tbody>
                    {% for row in matrix %}
                    {% if row.group == "total_other" %}
                    <tr class="total-row">
                        <td class="project-cell" style="cursor:default;">{{ row.label }}</td>
                        <td class="status-cell"></td>
                        {% for emp in employees %}
                        <td>{{ row.values|get_item:emp.id|zero_dash }}</td>
                        {% endfor %}
                        <td class="total-col">{{ row.total|zero_dash }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>

                <!-- Grand Total -->
                <tbody>
                    {% for row in matrix %}
                    {% if row.group == "grand_total" %}
                    <tr class="grand-total-row">
                        <td class="project-cell" style="cursor:default;">{{ row.label }}</td>
                        <td class="status-cell"></td>
                        {% for emp in employees %}
                        <td>{{ row.values|get_item:emp.id|zero_dash }}</td>
                        {% endfor %}
                        <td class="total-col">{{ row.total|zero_dash }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
