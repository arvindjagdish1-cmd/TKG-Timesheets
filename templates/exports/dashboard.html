{% extends "base.html" %}

{% block title %}Export Dashboard - Keystone{% endblock %}

{% block extra_css %}
<style>
    .export-card {
        background: var(--ks-bg-card);
        border: 1px solid var(--ks-border);
        border-radius: var(--radius);
        transition: all 0.2s ease;
    }
    .export-card:hover {
        border-color: var(--ks-border-light);
        transform: translateY(-2px);
    }
    .export-card .card-icon {
        width: 56px;
        height: 56px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    .export-card.timesheet .card-icon {
        background: var(--ks-accent-subtle);
        color: var(--ks-accent);
    }
    .export-card.expense .card-icon {
        background: var(--ks-success-subtle);
        color: var(--ks-success);
    }
    .export-card h5 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--ks-text-primary);
    }
    .export-card .form-label {
        color: var(--ks-text-secondary);
    }
    .badge-completed {
        background: var(--ks-success-subtle);
        color: var(--ks-success);
    }
    .badge-failed {
        background: var(--ks-danger-subtle);
        color: var(--ks-danger);
    }
    .badge-pending {
        background: var(--ks-warning-subtle);
        color: var(--ks-warning);
    }
    .export-type-icon {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
        font-size: 0.875rem;
    }
    .export-type-icon.timesheet {
        background: var(--ks-accent-subtle);
        color: var(--ks-accent);
    }
    .export-type-icon.expense {
        background: var(--ks-success-subtle);
        color: var(--ks-success);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="bi bi-file-earmark-arrow-down me-2" style="opacity: 0.7;"></i>Export Dashboard</h1>
        <p class="text-muted mb-0">Generate XLSX exports for timesheets and expenses</p>
    </div>
    <a href="{% url 'reviews:payroll_dashboard' %}" class="btn btn-secondary">
        <i class="bi bi-cash-coin me-2"></i>Payroll Export
    </a>
</div>

<div class="row g-4">
    <!-- Timesheet Exports -->
    <div class="col-lg-6">
        <div class="card export-card timesheet h-100">
            <div class="card-header">
                <i class="bi bi-clock me-2"></i>Timesheet Exports
            </div>
            <div class="card-body">
                <div class="card-icon">
                    <i class="bi bi-file-earmark-spreadsheet"></i>
                </div>
                <h5>Generate Timesheet Reports</h5>
                <form action="{% url 'exports:generate_timesheets' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Select Month</label>
                        <select name="month" class="form-select js-ts-month" required>
                            <option value="">— Choose a month —</option>
                            {% for y, m in ts_months %}
                            <option value="{{ m }}" data-year="{{ y }}">{{ y }}-{{ m|stringformat:"02d" }}</option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="year" class="js-ts-year" value="">
                    </div>
                    <p class="text-muted small mb-3">
                        Exports all submitted &amp; approved timesheets for the selected month.
                    </p>
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="bi bi-download me-2"></i>Generate Timesheets
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Exports -->
    <div class="col-lg-6">
        <div class="card export-card expense h-100">
            <div class="card-header">
                <i class="bi bi-receipt me-2"></i>Expense Exports
            </div>
            <div class="card-body">
                <div class="card-icon">
                    <i class="bi bi-file-earmark-text"></i>
                </div>
                <h5>Generate Expense Reports</h5>
                <form action="{% url 'exports:generate_expenses' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Select Month</label>
                        <select name="month" class="form-select js-exp-month" required>
                            <option value="">— Choose a month —</option>
                            {% for em in expense_months %}
                            <option value="{{ em.month }}" data-year="{{ em.year }}">{{ em.display_name }}</option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="year" class="js-exp-year" value="">
                    </div>
                    <p class="text-muted small mb-3">
                        Exports all submitted &amp; approved expense reports for the selected month.
                    </p>
                    <button type="submit" class="btn btn-success btn-lg w-100">
                        <i class="bi bi-download me-2"></i>Generate Expenses
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Recent Exports -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history me-2"></i>Recent Exports</span>
        <a href="{% url 'exports:export_list' %}" class="btn btn-sm btn-secondary">View All</a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Period</th>
                        <th>Employee</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th class="text-end">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for export in recent_exports %}
                    <tr>
                        <td>
                            {% if "TS" in export.export_type %}
                            <span class="export-type-icon timesheet">
                                <i class="bi bi-clock"></i>
                            </span>
                            {% else %}
                            <span class="export-type-icon expense">
                                <i class="bi bi-receipt"></i>
                            </span>
                            {% endif %}
                            {{ export.get_export_type_display }}
                        </td>
                        <td>{{ export.year }}-{{ export.month|stringformat:"02d" }}{% if export.half %} ({{ export.half }}){% endif %}</td>
                        <td>{{ export.employee.get_full_name|default:"All Employees" }}</td>
                        <td>
                            {% if export.status == "COMPLETED" %}
                            <span class="badge-status badge-completed">Completed</span>
                            {% elif export.status == "FAILED" %}
                            <span class="badge-status badge-failed">Failed</span>
                            {% else %}
                            <span class="badge-status badge-pending">{{ export.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td class="text-muted">{{ export.created_at|date:"M j, g:i A" }}</td>
                        <td class="text-end">
                            {% if export.file %}
                            <a href="{% url 'exports:download' export.pk %}" class="btn btn-sm btn-primary">
                                <i class="bi bi-download me-1"></i>Download
                            </a>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="bi bi-inbox h2 d-block mb-2 text-muted"></i>
                            <h6 class="text-muted">No Exports Yet</h6>
                            <p class="text-muted small mb-0">Generate your first export using the forms above.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll(".js-ts-month").forEach(function(sel) {
    sel.addEventListener("change", function() {
        var opt = sel.options[sel.selectedIndex];
        sel.closest("form").querySelector(".js-ts-year").value = opt.dataset.year || "";
    });
});
document.querySelectorAll(".js-exp-month").forEach(function(sel) {
    sel.addEventListener("change", function() {
        var opt = sel.options[sel.selectedIndex];
        sel.closest("form").querySelector(".js-exp-year").value = opt.dataset.year || "";
    });
});
</script>
{% endblock %}
